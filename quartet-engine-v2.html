<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quartet Engine V2.0 - String Quartet Composer with Fixed Export</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #6B73FF;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.2em;
        }
        
        .composer-styles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .style-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .style-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .style-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: scale(1.05);
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 600;
        }
        
        .control-group input,
        .control-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .score-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .instrument-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .instrument-label {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .note-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 4px;
            margin-bottom: 10px;
        }
        
        .note-cell {
            aspect-ratio: 1;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            background: white;
        }
        
        .note-cell:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }
        
        .note-cell.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }
        
        .note-cell.playing {
            animation: pulse 0.3s;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .visualization {
            background: #2d3748;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }
        
        .info-panel {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .info-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        
        .info-label {
            font-weight: bold;
            color: #4a5568;
            font-size: 0.9em;
        }
        
        .info-value {
            color: #2d3748;
            margin-top: 5px;
        }
        
        .preset-patterns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .pattern-btn {
            padding: 10px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .pattern-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .pattern-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéª Quartet Engine V2.0</h1>
            <div class="subtitle">Professional String Quartet Composer with MusicXML Export</div>
        </div>

        <div class="composer-styles">
            <button class="style-btn" onclick="loadStyle('baroque')">Baroque</button>
            <button class="style-btn" onclick="loadStyle('classical')">Classical</button>
            <button class="style-btn" onclick="loadStyle('romantic')">Romantic</button>
            <button class="style-btn" onclick="loadStyle('impressionist')">Impressionist</button>
            <button class="style-btn" onclick="loadStyle('modern')">Modern</button>
            <button class="style-btn" onclick="loadStyle('minimalist')">Minimalist</button>
            <button class="style-btn" onclick="loadStyle('folk')">Folk</button>
            <button class="style-btn" onclick="loadStyle('jazz')">Jazz-influenced</button>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="key">Key</label>
                <select id="key">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="A">A Major</option>
                    <option value="E">E Major</option>
                    <option value="B">B Major</option>
                    <option value="F">F Major</option>
                    <option value="Bb">B‚ô≠ Major</option>
                    <option value="Eb">E‚ô≠ Major</option>
                    <option value="Ab">A‚ô≠ Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                    <option value="Dm">D Minor</option>
                    <option value="Gm">G Minor</option>
                    <option value="Cm">C Minor</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="tempo">Tempo (BPM)</label>
                <input type="range" id="tempo" min="40" max="200" value="120">
                <span id="tempoValue">120</span>
            </div>
            
            <div class="control-group">
                <label for="timeSignature">Time Signature</label>
                <select id="timeSignature">
                    <option value="4/4">4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="6/8">6/8</option>
                    <option value="5/4">5/4</option>
                    <option value="7/8">7/8</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="measures">Measures</label>
                <input type="number" id="measures" min="1" max="32" value="8">
            </div>
            
            <div class="control-group">
                <label for="dynamics">Dynamics</label>
                <select id="dynamics">
                    <option value="pp">pp (pianissimo)</option>
                    <option value="p">p (piano)</option>
                    <option value="mp">mp (mezzo-piano)</option>
                    <option value="mf" selected>mf (mezzo-forte)</option>
                    <option value="f">f (forte)</option>
                    <option value="ff">ff (fortissimo)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="articulation">Articulation</label>
                <select id="articulation">
                    <option value="legato">Legato</option>
                    <option value="staccato">Staccato</option>
                    <option value="marcato">Marcato</option>
                    <option value="pizzicato">Pizzicato</option>
                    <option value="arco">Arco</option>
                    <option value="tremolo">Tremolo</option>
                    <option value="spiccato">Spiccato</option>
                </select>
            </div>
        </div>

        <div class="preset-patterns">
            <button class="pattern-btn" onclick="loadPattern('canon')">Canon</button>
            <button class="pattern-btn" onclick="loadPattern('fugue')">Fugue</button>
            <button class="pattern-btn" onclick="loadPattern('sonata')">Sonata Form</button>
            <button class="pattern-btn" onclick="loadPattern('rondo')">Rondo</button>
            <button class="pattern-btn" onclick="loadPattern('theme-variations')">Theme & Variations</button>
            <button class="pattern-btn" onclick="loadPattern('waltz')">Waltz</button>
            <button class="pattern-btn" onclick="loadPattern('march')">March</button>
            <button class="pattern-btn" onclick="loadPattern('lullaby')">Lullaby</button>
        </div>

        <div class="buttons">
            <button class="btn btn-primary" onclick="generateComposition()">üéµ Generate</button>
            <button class="btn btn-success" onclick="playComposition()">‚ñ∂Ô∏è Play</button>
            <button class="btn btn-danger" onclick="stopPlayback()">‚èπÔ∏è Stop</button>
            <button class="btn btn-info" onclick="exportMusicXML()">üì• Export MusicXML</button>
            <button class="btn btn-info" onclick="exportMIDI()">üíæ Export MIDI</button>
            <button class="btn btn-primary" onclick="randomize()">üé≤ Randomize</button>
            <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear</button>
        </div>

        <div class="visualization" id="visualization">
            Click "Generate" to create a string quartet composition
        </div>

        <div class="score-container">
            <div class="instrument-section">
                <div class="instrument-label">
                    Violin I
                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;" onclick="clearInstrument('violin1')">Clear</button>
                </div>
                <div class="note-grid" id="violin1-grid"></div>
            </div>
            
            <div class="instrument-section">
                <div class="instrument-label">
                    Violin II
                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;" onclick="clearInstrument('violin2')">Clear</button>
                </div>
                <div class="note-grid" id="violin2-grid"></div>
            </div>
            
            <div class="instrument-section">
                <div class="instrument-label">
                    Viola
                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;" onclick="clearInstrument('viola')">Clear</button>
                </div>
                <div class="note-grid" id="viola-grid"></div>
            </div>
            
            <div class="instrument-section">
                <div class="instrument-label">
                    Cello
                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em;" onclick="clearInstrument('cello')">Clear</button>
                </div>
                <div class="note-grid" id="cello-grid"></div>
            </div>
        </div>

        <div class="info-panel">
            <h3>Composition Info</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Current Style</div>
                    <div class="info-value" id="currentStyle">None</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Key</div>
                    <div class="info-value" id="currentKey">C Major</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Tempo</div>
                    <div class="info-value" id="currentTempo">120 BPM</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Pattern</div>
                    <div class="info-value" id="currentPattern">None</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let currentStyle = null;
        let currentPattern = null;
        let isPlaying = false;
        let playbackInterval = null;
        let currentBeat = 0;
        
        // Instrument data
        const instruments = [
            { id: 'violin1', name: 'Violin I', clef: 'treble', range: ['G3', 'A7'] },
            { id: 'violin2', name: 'Violin II', clef: 'treble', range: ['G3', 'A7'] },
            { id: 'viola', name: 'Viola', clef: 'alto', range: ['C3', 'E6'] },
            { id: 'cello', name: 'Cello', clef: 'bass', range: ['C2', 'C6'] }
        ];
        
        // Note patterns for each instrument
        let patterns = {
            violin1: new Array(16).fill(null),
            violin2: new Array(16).fill(null),
            viola: new Array(16).fill(null),
            cello: new Array(16).fill(null)
        };
        
        // Music theory
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const majorScale = [0, 2, 4, 5, 7, 9, 11];
        const minorScale = [0, 2, 3, 5, 7, 8, 10];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeGrids();
            setupEventListeners();
            updateInfo();
        });
        
        // Initialize grids
        function initializeGrids() {
            instruments.forEach(instrument => {
                const grid = document.getElementById(`${instrument.id}-grid`);
                grid.innerHTML = '';
                
                for (let i = 0; i < 16; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'note-cell';
                    cell.id = `${instrument.id}-${i}`;
                    cell.onclick = () => toggleNote(instrument.id, i);
                    grid.appendChild(cell);
                }
            });
        }
        
        // Load composer style
        function loadStyle(style) {
            currentStyle = style;
            
            // Update active button
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Set style-specific parameters
            const styleSettings = {
                baroque: { tempo: 120, timeSignature: '4/4', dynamics: 'mf', articulation: 'legato' },
                classical: { tempo: 120, timeSignature: '4/4', dynamics: 'mp', articulation: 'legato' },
                romantic: { tempo: 80, timeSignature: '3/4', dynamics: 'f', articulation: 'legato' },
                impressionist: { tempo: 72, timeSignature: '4/4', dynamics: 'p', articulation: 'legato' },
                modern: { tempo: 140, timeSignature: '7/8', dynamics: 'ff', articulation: 'marcato' },
                minimalist: { tempo: 144, timeSignature: '4/4', dynamics: 'mp', articulation: 'staccato' },
                folk: { tempo: 96, timeSignature: '3/4', dynamics: 'mf', articulation: 'legato' },
                'jazz-influenced': { tempo: 120, timeSignature: '4/4', dynamics: 'mf', articulation: 'legato' }
            };
            
            const settings = styleSettings[style];
            if (settings) {
                document.getElementById('tempo').value = settings.tempo;
                document.getElementById('tempoValue').textContent = settings.tempo;
                document.getElementById('timeSignature').value = settings.timeSignature;
                document.getElementById('dynamics').value = settings.dynamics;
                document.getElementById('articulation').value = settings.articulation;
            }
            
            updateInfo();
            generateComposition();
        }
        
        // Load pattern
        function loadPattern(pattern) {
            currentPattern = pattern;
            
            // Update active button
            document.querySelectorAll('.pattern-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateInfo();
            generatePatternComposition(pattern);
        }
        
        // Generate composition
        function generateComposition() {
            clearAll();
            
            const key = document.getElementById('key').value;
            const isMinor = key.includes('m');
            
            // Generate based on style
            if (currentStyle) {
                switch(currentStyle) {
                    case 'baroque':
                        generateBaroque();
                        break;
                    case 'classical':
                        generateClassical();
                        break;
                    case 'romantic':
                        generateRomantic();
                        break;
                    case 'modern':
                        generateModern();
                        break;
                    default:
                        generateRandom();
                }
            } else {
                generateRandom();
            }
            
            updateDisplay();
        }
        
        // Generate Baroque style
        function generateBaroque() {
            // Violin 1: Main theme with ornamentations
            for (let i = 0; i < 16; i++) {
                if (i % 2 === 0 || Math.random() > 0.3) {
                    patterns.violin1[i] = 'E5';
                }
            }
            
            // Violin 2: Counter-melody
            for (let i = 0; i < 16; i++) {
                if (i % 3 === 1) {
                    patterns.violin2[i] = 'C5';
                }
            }
            
            // Viola: Harmonic support
            for (let i = 0; i < 16; i++) {
                if (i % 4 === 0) {
                    patterns.viola[i] = 'G4';
                }
            }
            
            // Cello: Bass line
            for (let i = 0; i < 16; i++) {
                if (i % 8 === 0) {
                    patterns.cello[i] = 'C3';
                }
            }
        }
        
        // Generate Classical style
        function generateClassical() {
            // Clear alberti bass pattern
            for (let i = 0; i < 16; i++) {
                if (i % 4 === 0) patterns.violin1[i] = 'G5';
                if (i % 4 === 1) patterns.violin2[i] = 'E5';
                if (i % 2 === 0) patterns.viola[i] = 'C4';
                if (i % 8 === 0) patterns.cello[i] = 'C3';
            }
        }
        
        // Generate Romantic style
        function generateRomantic() {
            // Lush harmonies and expressive melodies
            for (let i = 0; i < 16; i++) {
                if (Math.random() > 0.5) patterns.violin1[i] = 'A5';
                if (Math.random() > 0.6) patterns.violin2[i] = 'F5';
                if (i % 3 === 0) patterns.viola[i] = 'D4';
                if (i % 6 === 0) patterns.cello[i] = 'D3';
            }
        }
        
        // Generate Modern style
        function generateModern() {
            // Dissonant intervals and irregular rhythms
            for (let i = 0; i < 16; i++) {
                if (Math.random() > 0.7) patterns.violin1[i] = 'F#5';
                if (Math.random() > 0.7) patterns.violin2[i] = 'G5';
                if (Math.random() > 0.6) patterns.viola[i] = 'Eb4';
                if (i % 5 === 0) patterns.cello[i] = 'Bb2';
            }
        }
        
        // Generate pattern-based composition
        function generatePatternComposition(pattern) {
            clearAll();
            
            switch(pattern) {
                case 'canon':
                    // Each voice enters with the same melody, offset
                    const cannonMelody = ['C5', null, 'E5', null, 'G5', null, 'E5', null];
                    for (let i = 0; i < 8; i++) {
                        patterns.violin1[i] = cannonMelody[i];
                        patterns.violin2[i + 2] = cannonMelody[i];
                        patterns.viola[i + 4] = cannonMelody[i] ? cannonMelody[i].replace('5', '4') : null;
                        patterns.cello[i + 6] = cannonMelody[i] ? cannonMelody[i].replace('5', '3') : null;
                    }
                    break;
                    
                case 'waltz':
                    // 3/4 time feel
                    document.getElementById('timeSignature').value = '3/4';
                    for (let i = 0; i < 16; i++) {
                        if (i % 3 === 0) patterns.violin1[i] = 'E5';
                        if (i % 3 === 1) patterns.violin2[i] = 'C5';
                        if (i % 3 === 2) patterns.viola[i] = 'G4';
                        if (i % 6 === 0) patterns.cello[i] = 'C3';
                    }
                    break;
                    
                default:
                    generateRandom();
            }
            
            updateDisplay();
        }
        
        // Generate random composition
        function generateRandom() {
            instruments.forEach(instrument => {
                for (let i = 0; i < 16; i++) {
                    if (Math.random() > 0.6) {
                        const noteOptions = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                        const octave = instrument.id.includes('violin') ? '5' : 
                                      instrument.id === 'viola' ? '4' : '3';
                        patterns[instrument.id][i] = noteOptions[Math.floor(Math.random() * noteOptions.length)] + octave;
                    } else {
                        patterns[instrument.id][i] = null;
                    }
                }
            });
        }
        
        // Toggle note
        function toggleNote(instrumentId, beat) {
            const noteOptions = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const octave = instrumentId.includes('violin') ? '5' : 
                          instrumentId === 'viola' ? '4' : '3';
            
            if (patterns[instrumentId][beat]) {
                patterns[instrumentId][beat] = null;
            } else {
                patterns[instrumentId][beat] = noteOptions[Math.floor(Math.random() * noteOptions.length)] + octave;
            }
            
            updateDisplay();
        }
        
        // Update display
        function updateDisplay() {
            instruments.forEach(instrument => {
                for (let i = 0; i < 16; i++) {
                    const cell = document.getElementById(`${instrument.id}-${i}`);
                    if (patterns[instrument.id][i]) {
                        cell.classList.add('active');
                        cell.textContent = patterns[instrument.id][i];
                    } else {
                        cell.classList.remove('active');
                        cell.textContent = '';
                    }
                }
            });
        }
        
        // Play composition
        function playComposition() {
            if (isPlaying) return;
            
            isPlaying = true;
            currentBeat = 0;
            
            const tempo = parseInt(document.getElementById('tempo').value);
            const interval = 60000 / (tempo * 4); // 16th notes
            
            playbackInterval = setInterval(() => {
                // Clear previous highlights
                document.querySelectorAll('.note-cell.playing').forEach(cell => {
                    cell.classList.remove('playing');
                });
                
                // Highlight current beat
                instruments.forEach(instrument => {
                    const cell = document.getElementById(`${instrument.id}-${currentBeat}`);
                    if (patterns[instrument.id][currentBeat]) {
                        cell.classList.add('playing');
                    }
                });
                
                // Update visualization
                updateVisualization();
                
                currentBeat = (currentBeat + 1) % 16;
            }, interval);
        }
        
        // Stop playback
        function stopPlayback() {
            isPlaying = false;
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
            }
            
            document.querySelectorAll('.note-cell.playing').forEach(cell => {
                cell.classList.remove('playing');
            });
            
            currentBeat = 0;
        }
        
        // Update visualization
        function updateVisualization() {
            const viz = document.getElementById('visualization');
            const activeNotes = instruments.map(inst => patterns[inst.id][currentBeat]).filter(n => n);
            
            if (activeNotes.length > 0) {
                viz.innerHTML = `
                    <div>
                        <h3>Beat ${currentBeat + 1}</h3>
                        <p>Playing: ${activeNotes.join(', ')}</p>
                    </div>
                `;
            } else {
                viz.innerHTML = `<div><h3>Beat ${currentBeat + 1}</h3><p>Rest</p></div>`;
            }
        }
        
        // Export to MusicXML - FIXED VERSION
        function exportMusicXML() {
            const tempo = parseInt(document.getElementById('tempo').value);
            const measures = parseInt(document.getElementById('measures').value);
            const [beatsPerMeasure, beatType] = document.getElementById('timeSignature').value.split('/').map(Number);
            const key = document.getElementById('key').value;
            
            // Create MusicXML content
            let xml = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <identification>
    <creator type="composer">Mike Bryant</creator>
    <encoding>
      <software>Quartet Engine V2.0</software>
      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
    </encoding>
  </identification>
  <defaults>
    <scaling>
      <millimeters>7.05556</millimeters>
      <tenths>40</tenths>
    </scaling>
  </defaults>
  <part-list>`;
            
            // Add parts for each instrument
            instruments.forEach((instrument, idx) => {
                xml += `
    <score-part id="P${idx + 1}">
      <part-name>${instrument.name}</part-name>
      <score-instrument id="P${idx + 1}-I1">
        <instrument-name>${instrument.name}</instrument-name>
      </score-instrument>
      <midi-instrument id="P${idx + 1}-I1">
        <midi-channel>1</midi-channel>
        <midi-program>${41 + idx}</midi-program>
        <volume>78</volume>
        <pan>0</pan>
      </midi-instrument>
    </score-part>`;
            });
            
            xml += `
  </part-list>`;
            
            // Add parts with notes
            instruments.forEach((instrument, partIdx) => {
                xml += `
  <part id="P${partIdx + 1}">`;
                
                for (let measure = 0; measure < measures; measure++) {
                    xml += `
    <measure number="${measure + 1}">`;
                    
                    // Add attributes only in first measure
                    if (measure === 0) {
                        const clefSign = instrument.clef === 'treble' ? 'G' : instrument.clef === 'alto' ? 'C' : 'F';
                        const clefLine = instrument.clef === 'treble' ? '2' : instrument.clef === 'alto' ? '3' : '4';
                        
                        xml += `
      <attributes>
        <divisions>4</divisions>
        <key>
          <fifths>${getKeySignature(key)}</fifths>
        </key>
        <time>
          <beats>${beatsPerMeasure}</beats>
          <beat-type>${beatType}</beat-type>
        </time>
        <clef>
          <sign>${clefSign}</sign>
          <line>${clefLine}</line>
        </clef>
      </attributes>
      <direction placement="above">
        <direction-type>
          <metronome>
            <beat-unit>quarter</beat-unit>
            <per-minute>${tempo}</per-minute>
          </metronome>
        </direction-type>
      </direction>`;
                    }
                    
                    // Generate notes for this measure
                    const beatsInMeasure = beatsPerMeasure * 4; // 16th note resolution
                    const startBeat = (measure * beatsInMeasure) % 16;
                    
                    for (let beat = 0; beat < beatsInMeasure && beat < 16; beat++) {
                        const beatIdx = (startBeat + beat) % 16;
                        const note = patterns[instrument.id][beatIdx];
                        
                        if (note) {
                            const step = note[0];
                            const octave = note[1];
                            
                            xml += `
      <note>
        <pitch>
          <step>${step}</step>
          <octave>${octave}</octave>
        </pitch>
        <duration>1</duration>
        <type>16th</type>
      </note>`;
                        } else {
                            // Add rest
                            xml += `
      <note>
        <rest/>
        <duration>1</duration>
        <type>16th</type>
      </note>`;
                        }
                    }
                    
                    xml += `
    </measure>`;
                }
                
                xml += `
  </part>`;
            });
            
            xml += `
</score-partwise>`;
            
            // Download the file with proper MIME type
            const blob = new Blob([xml], { type: 'application/vnd.recordare.musicxml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quartet_engine_${currentStyle || 'composition'}_${new Date().getTime()}.musicxml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Get key signature
        function getKeySignature(key) {
            const signatures = {
                'C': 0, 'G': 1, 'D': 2, 'A': 3, 'E': 4, 'B': 5,
                'F': -1, 'Bb': -2, 'Eb': -3, 'Ab': -4,
                'Am': 0, 'Em': 1, 'Dm': -1, 'Gm': -2, 'Cm': -3
            };
            return signatures[key] || 0;
        }
        
        // Export MIDI (placeholder)
        function exportMIDI() {
            alert('MIDI export coming soon! Use MusicXML export for now.');
        }
        
        // Clear instrument
        function clearInstrument(instrumentId) {
            patterns[instrumentId] = new Array(16).fill(null);
            updateDisplay();
        }
        
        // Clear all
        function clearAll() {
            instruments.forEach(inst => {
                patterns[inst.id] = new Array(16).fill(null);
            });
            updateDisplay();
            document.getElementById('visualization').innerHTML = 'Click "Generate" to create a string quartet composition';
        }
        
        // Randomize
        function randomize() {
            const styles = ['baroque', 'classical', 'romantic', 'impressionist', 'modern', 'minimalist', 'folk', 'jazz-influenced'];
            loadStyle(styles[Math.floor(Math.random() * styles.length)]);
        }
        
        // Update info panel
        function updateInfo() {
            document.getElementById('currentStyle').textContent = currentStyle || 'None';
            document.getElementById('currentKey').textContent = document.getElementById('key').options[document.getElementById('key').selectedIndex].text;
            document.getElementById('currentTempo').textContent = document.getElementById('tempo').value + ' BPM';
            document.getElementById('currentPattern').textContent = currentPattern || 'None';
        }
        
        // Setup event listeners
        function setupEventListeners() {
            const tempoSlider = document.getElementById('tempo');
            tempoSlider.addEventListener('input', function() {
                document.getElementById('tempoValue').textContent = this.value;
                updateInfo();
            });
            
            document.getElementById('key').addEventListener('change', updateInfo);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (isPlaying) {
                        stopPlayback();
                    } else {
                        playComposition();
                    }
                } else if (e.code === 'Escape') {
                    stopPlayback();
                }
            });
        }
    </script>
</body>
</html>